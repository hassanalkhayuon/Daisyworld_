clear

% Code created by Hassan alkhayuon. bifurcation analysis (Using COCO) 
% for the Daisy world model, collaburation with Constantin W. Arnscheidt

%% we first define the odefunction and it's jacobian 
L0 = 0.5;
eq0_guess = [0; 0];
L1 = 1.45;
eq1_guess = [0.6987; 0];
L2 = 0.66;
eq2_guess = [0; 0.6987];
L3 = 1;
eq3_guess = [0.41; 0.25];

odefun = @(var,par)DaisyW(var,par);
% % A good guess of the equilibrium point L = 0.5
% eq_guess = [0.6 0];
% [~,var] = ode45(@(t,var)odefun(var,L),[0 1000],eq_guess);
% eq_guess = var(end,:)';

%% coco contunation 
% prob0 = coco_prob();
% prob0 = coco_set(...
%     prob0, 'ode', 'vectorized', false);
% prob0 = coco_set(prob0,'cont','h_max',0.1,'h_min',0.01,'h0',0.01,'PtMX',10000);
% prob0 = ode_isol2ep(prob0,'', odefun, eq0_guess, {'L'}, L0);
% bd0 = coco(prob0,'DaisyW_q0',[],1, 'L', [0.5 2]);
% 
% prob1 = coco_prob();
% prob1 = coco_set(...
%     prob1, 'ode', 'vectorized', false);
% prob1 = coco_set(prob1,'cont','h_max',0.1,'h_min',0.01,'h0',0.01,'PtMX',10000);
% prob1 = ode_isol2ep(prob1,'', odefun, eq1_guess, {'L'}, L1);
% bd1 = coco(prob1,'DaisyW_q1',[],1, 'L', [0.5 1.6]);
% 
% prob2 = coco_prob();
% prob2 = coco_set(...
%     prob2, 'ode', 'vectorized', false);
% prob2 = coco_set(prob2,'cont','h_max',0.1,'h_min',0.01,'h0',0.01,'PtMX',10000);
% prob2 = ode_isol2ep(prob2,'', odefun, eq2_guess, {'L'}, L2);
% bd2 = coco(prob2,'DaisyW_q2',[],1, 'L', [0.5 1.6]);
% 
% prob3 = coco_prob();
% prob3 = coco_set(...
%     prob3, 'ode', 'vectorized', false);
% prob3 = coco_set(prob3,'cont','h_max',0.1,'h_min',0.01,'h0',0.01,'PtMX',10000);
% prob3 = ode_isol2ep(prob3,'', odefun, eq3_guess, {'L'}, L3);
% bd3 = coco(prob3,'DaisyW_q3',[],1, 'L', [0.5 1.6]);
%% extracting e_0.
bd0 = coco_bd_read('DaisyW_q0');
ind0_b = coco_bd_idxs(bd0, 'BP');
e0 = coco_bd_col(bd0, 'x');
LL0 = coco_bd_col(bd0, {'L'});
%% extracting e_12.
bd1 = coco_bd_read('DaisyW_q1');
ind1_b = coco_bd_idxs(bd1, 'SN');
e12 = coco_bd_col(bd1, 'x');
LL12 = coco_bd_col(bd1, {'L'});

%% extracting e_34.
bd2 = coco_bd_read('DaisyW_q2');
ind2_b = coco_bd_idxs(bd2, 'SN');
e34 = coco_bd_col(bd2, 'x');
LL34 = coco_bd_col(bd2, {'L'});

%% extracting e_5.
bd3 = coco_bd_read('DaisyW_q3');
ind3_b = coco_bd_idxs(bd3, 'BP');
e5 = coco_bd_col(bd3, 'x');
LL5 = coco_bd_col(bd3, {'L'});

%% plotting 
% e0
figure(1); 
cla
hold on

plot3(...
    LL0(1:ind0_b(1)),...
    e0(1,1:ind0_b(1)),...
    e0(2,1:ind0_b(1)),...
    '-k','LineWidth',2)
plot3(...
    LL0(ind0_b(1):ind0_b(end)),...
    e0(1,ind0_b(1):ind0_b(end)),...
    e0(2,ind0_b(1):ind0_b(end)),...
    '--k','LineWidth',2)
plot3(...
    LL0(ind0_b(end):end),...
    e0(1,ind0_b(end):end),...
    e0(2,ind0_b(end):end),...
    '-k','LineWidth',2)
% 
% e12
plot3(...
    LL12(1:ind1_b(2)),...
    e12(1,1:ind1_b(2)),...
    e12(2,1:ind1_b(2)),...
    '--k','LineWidth',2)
plot3(...
    LL12(ind1_b(2):ind1_b(3)),...
    e12(1,ind1_b(2):ind1_b(3)),...
    e12(2,ind1_b(2):ind1_b(3)),...
    '-k','LineWidth',2)
plot3(...
    LL12(ind1_b(3):end),...
    e12(1,ind1_b(3):end),...
    e12(2,ind1_b(3):end),...
    '--k','LineWidth',2)

% e34
plot3(...
    LL34(ind2_b(1):ind2_b(2)),...
    e34(1,ind2_b(1):ind2_b(2)),...
    e34(2,ind2_b(1):ind2_b(2)),...
    '--k','LineWidth',2)
% 
plot3(...
    LL34(ind2_b(2):ind2_b(3)),...
    e34(1,ind2_b(2):ind2_b(3)),...
    e34(2,ind2_b(2):ind2_b(3)),...
    '-k','LineWidth',2)

plot3(...
    LL34(ind2_b(3):ind2_b(4)),...
    e34(1,ind2_b(3):ind2_b(4)),...
    e34(2,ind2_b(3):ind2_b(4)),...
    '--k','LineWidth',2)

% e5
plot3(...
    LL5,e5(1,:), e5(2,:),...
    '-k','LineWidth',2)

% fold points 

plot3(...
    LL12(ind1_b(3)), e12(1,ind1_b(3)),e12(2,ind1_b(3)),...
    '.k','MarkerSize',30)

plot3(...
    LL34(ind1_b(2)), e34(1,ind1_b(2)),e34(2,ind1_b(2)),...
    '.k','MarkerSize',30)

% transicritical in e0

plot3(...
    LL0(ind0_b(4)), e0(1,ind0_b(4)),e0(2,ind0_b(4)),...
    '.k','MarkerSize',30)

plot3(...
    LL0(ind0_b(3)), e0(1,ind0_b(3)),e0(2,ind0_b(3)),...
    '.k','MarkerSize',30)

plot3(...
    LL0(ind0_b(2)), e0(1,ind0_b(2)),e0(2,ind0_b(2)),...
    '.k','MarkerSize',30)

plot3(...
    LL0(ind0_b(1)), e0(1,ind0_b(1)),e0(2,ind0_b(1)),...
    '.k','MarkerSize',30)

% transictitical in e5

plot3(...
    LL5(ind3_b(1)), e5(1,ind3_b(1)),e5(2,ind3_b(1)),...
    '.k','MarkerSize',30)

plot3(...
    LL5(ind3_b(2)), e5(1,ind3_b(2)),e5(2,ind3_b(2)),...
    '.k','MarkerSize',30)


axis([0.6 1.6 0 0.8 0 0.8])
view([120 20])
box on
grid on

xlabel('$L$')
ylabel('$\alpha_w$')
zlabel('$\alpha_b$','Rotation',0)

%% 2D bifurcations 
plot(...
    LL12(ind1_b(3)), e12(1,ind1_b(3)), ...
    '.k','MarkerSize',30)

plot(...
    0.625812, 0.55261,...
    '.k','MarkerSize',30)

%% plotting
% figure; plot(rho,var(1,:))
% figure; hold on
% plot(rho(H_ind),var(1,H_ind),'.k','MarkerSize',30)
% plot(rho(1:H_ind(1)),var(1,1:H_ind(1)),'k-')
% plot(rho(H_ind(2):end),var(1,H_ind(2):end),'k-')
% plot(rho(H_ind(1):H_ind(2)),var(1,H_ind(1):H_ind(2)),'k--')

%% ode function of the may model 